{
  "feature_id": "ui.kanban.filters.type+date.only",
  "goal": "Cambiar SOLO los filtros del Kanban para filtrar por tipo de transacción y por fecha, sin tocar estados ni columnas.",
  "constraints": [
    "No modificar columnas ni estados (created, settled, failed).",
    "Eliminar cualquier lógica de filtro por estado desde UI.",
    "Mantener la agrupación y render por columnas existentes."
  ],
  "files_touched_max": 2,
  "routes_affected": ["/transactions"],
  "filters": {
    "tradeType": [
      { "value": "all", "label": "Todas" },
      { "value": "fiat_to_crypto", "label": "Fiat → Crypto (Venta de Crypto)" },
      { "value": "crypto_to_fiat", "label": "Crypto → Fiat (Compra de Crypto)" }
    ],
    "datePreset": [
      { "value": "today", "label": "Hoy" },
      { "value": "this_week", "label": "Esta semana" },
      { "value": "this_month", "label": "Este mes" },
      { "value": "range", "label": "Rango" }
    ],
    "range_fields": { "from": "YYYY-MM-DD", "to": "YYYY-MM-DD" }
  },
  "api_contract": {
    "list": {
      "method": "GET",
      "path": "/api/transactions",
      "query": [
        "type=all|fiat_to_crypto|crypto_to_fiat",
        "datePreset=today|this_week|this_month|range",
        "from=YYYY-MM-DD (si datePreset=range)",
        "to=YYYY-MM-DD (si datePreset=range)",
        "limit=number (default 50)",
        "cursor=string (opcional)"
      ],
      "response_shape": { "items": [], "nextCursor": "string|null" }
    }
  },
  "state_shape": {
    "filters": {
      "type": "all",
      "datePreset": "today",
      "from": null,
      "to": null
    }
  },
  "ui_spec_min": {
    "filterBar": "Una sola línea: [Tipo Select] [Fecha Select] [Desde (si Rango)] [Hasta (si Rango)] [Reset]",
    "interaction": [
      "Cambiar Tipo → refetch",
      "Cambiar Fecha → si != range refetch; si range, refetch al tener ambos campos",
      "Reset → {type:'all', datePreset:'today', from:null, to:null}"
    ]
  },
  "code": {
    "src/components/Filters.tsx": [
      "import React from 'react';",
      "",
      "type FilterValue = {",
      "  type: 'all'|'fiat_to_crypto'|'crypto_to_fiat';",
      "  datePreset: 'today'|'this_week'|'this_month'|'range';",
      "  from?: string|null;",
      "  to?: string|null;",
      "};",
      "",
      "type Props = { value: FilterValue; onChange: (next: FilterValue) => void; };",
      "",
      "const TYPES = [",
      "  {value:'all', label:'Todas'},",
      "  {value:'fiat_to_crypto', label:'Fiat → Crypto (Venta de Crypto)'},",
      "  {value:'crypto_to_fiat', label:'Crypto → Fiat (Compra de Crypto)'}",
      "];",
      "const DATES = [",
      "  {value:'today', label:'Hoy'},",
      "  {value:'this_week', label:'Esta semana'},",
      "  {value:'this_month', label:'Este mes'},",
      "  {value:'range', label:'Rango'}",
      "];",
      "",
      "export default function Filters({value, onChange}: Props){",
      "  function upd<K extends keyof FilterValue>(k:K, v: FilterValue[K]){",
      "    const next = {...value, [k]: v};",
      "    if(k==='datePreset' && v !== 'range'){ next.from = null as any; next.to = null as any; }",
      "    onChange(next);",
      "  }",
      "  function reset(){ onChange({ type:'all', datePreset:'today', from:null, to:null }); }",
      "",
      "  return (",
      "    <div className=\"flex flex-wrap items-center gap-2\">",
      "      <select",
      "        className=\"h-9 px-2 rounded border\"",
      "        value={value.type}",
      "        onChange={e=>upd('type', e.target.value as any)}",
      "        aria-label=\"Tipo de operación\">",
      "        {TYPES.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}",
      "      </select>",
      "",
      "      <select",
      "        className=\"h-9 px-2 rounded border\"",
      "        value={value.datePreset}",
      "        onChange={e=>upd('datePreset', e.target.value as any)}",
      "        aria-label=\"Rango de fecha\">",
      "        {DATES.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}",
      "      </select>",
      "",
      "      {value.datePreset==='range' && (",
      "        <>",
      "          <input type=\"date\"",
      "            className=\"h-9 px-2 rounded border\"",
      "            value={value.from ?? ''}",
      "            onChange={e=>upd('from', e.target.value as any)}",
      "            aria-label=\"Desde\"/>",
      "          <input type=\"date\"",
      "            className=\"h-9 px-2 rounded border\"",
      "            value={value.to ?? ''}",
      "            onChange={e=>upd('to', e.target.value as any)}",
      "            aria-label=\"Hasta\"/>",
      "        </>",
      "      )}",
      "",
      "      <button type=\"button\" onClick={reset} className=\"h-9 px-3 rounded border\">Reset</button>",
      "    </div>",
      "  );",
      "}"
    ],
    "src/pages/Kanban.tsx::patch": [
      "import React, {useEffect, useMemo, useState} from 'react';",
      "import Filters from '../components/Filters';",
      "",
      "type Tx = { id:string; type:'fiat_to_crypto'|'crypto_to_fiat'; status:'created'|'settled'|'failed'; createdAt:string; /* otros campos */ };",
      "",
      "const COLS = [",
      "  { key:'created', title:'Creadas' },",
      "  { key:'settled', title:'Liquidadas' },",
      "  { key:'failed', title:'Fallidas' }",
      "] as const; // NO CAMBIAR",
      "",
      "export default function Kanban(){",
      "  const [filters, setFilters] = useState({",
      "    type:'all' as 'all'|'fiat_to_crypto'|'crypto_to_fiat',",
      "    datePreset:'today' as 'today'|'this_week'|'this_month'|'range',",
      "    from:null as string|null,",
      "    to:null as string|null",
      "  });",
      "  const [items, setItems] = useState<Tx[]>([]);",
      "  const [loading, setLoading] = useState(false);",
      "",
      "  function buildQuery(){",
      "    const q = new URLSearchParams();",
      "    q.set('type', filters.type);",
      "    q.set('datePreset', filters.datePreset);",
      "    if(filters.datePreset==='range'){ if(filters.from) q.set('from', filters.from); if(filters.to) q.set('to', filters.to); }",
      "    q.set('limit','50');",
      "    return q.toString();",
      "  }",
      "",
      "  async function fetchData(){",
      "    setLoading(true);",
      "    try{",
      "      const res = await fetch(`/api/transactions?${buildQuery()}`);",
      "      const data = await res.json();",
      "      setItems(data.items || []);",
      "    } finally { setLoading(false); }",
      "  }",
      "",
      "  useEffect(()=>{",
      "    if(filters.datePreset==='range' && !(filters.from && filters.to)) return;",
      "    fetchData();",
      "    // eslint-disable-next-line react-hooks/exhaustive-deps",
      "  }, [filters.type, filters.datePreset, filters.from, filters.to]);",
      "",
      "  const byCol = useMemo(()=>{",
      "    const m: Record<string, Tx[]> = { created:[], settled:[], failed:[] };",
      "    for(const tx of items){ m[tx.status].push(tx); }",
      "    return m;",
      "  }, [items]);",
      "",
      "  return (",
      "    <div className=\"p-4 space-y-4\">",
      "      <Filters value={filters} onChange={setFilters} />",
      "      {loading && <div className=\"text-sm text-slate-500\">Cargando…</div>}",
      "      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">",
      "        {COLS.map(c=> (",
      "          <section key={c.key} className=\"rounded-xl bg-white shadow p-3\">",
      "            <header className=\"flex items-center justify-between mb-3\">",
      "              <h2 className=\"font-semibold\">{c.title}</h2>",
      "              <span className=\"text-xs text-slate-500\">{byCol[c.key].length} ítems</span>",
      "            </header>",
      "            <ul className=\"space-y-2\">",
      "              {byCol[c.key].map(tx=> (",
      "                <li key={tx.id} className=\"rounded border p-2\">",
      "                  <div className=\"text-sm font-medium\">{tx.id}</div>",
      "                  <div className=\"text-xs text-slate-500\">{tx.type} · {new Date(tx.createdAt).toLocaleString()}</div>",
      "                </li>",
      "              ))}",
      "            </ul>",
      "          </section>",
      "        ))}",
      "      </div>",
      "    </div>",
      "  );",
      "}"
    ]
  },
  "gwt": [
    "Given el usuario abre /transactions When elige 'Fiat → Crypto (Venta de Crypto)' Then el Kanban mantiene sus columnas y solo muestra transacciones de ese tipo.",
    "Given el usuario elige 'Esta semana' Then solo se muestran transacciones creadas en la semana actual, sin cambiar columnas.",
    "Given el usuario selecciona 'Rango' y define Desde/Hasta Then se filtra por ese intervalo de fechas.",
    "Given el usuario pulsa Reset Then los filtros vuelven a {type:'all', datePreset:'today'}."
  ],
  "perf": {
    "refetch_policy": "Evitar llamadas hasta tener from y to cuando datePreset='range'.",
    "limit_default": 50,
    "no_extra_libs": true
  }
}
